{{ define "admin_users.html" }}
<h2 class="mb-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

<table class="table table-bordered">
    <thead>
    <tr>
        <th>ID</th>
        <th>–ò–º—è</th>
        <th>Email</th>
        <th>–†–æ–ª—å</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody id="usersTableBody"></tbody>
</table>

<script>
    async function loadUsers() {
        const res = await fetch("/api/users", {
            headers: { Authorization: "Bearer " + localStorage.getItem("token") }
        });
        const users = await res.json();
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = "";

        users.forEach(user => {
            const isSuperadmin = user.role === "superadmin";
            const roleBadge = isSuperadmin ? "üõ°Ô∏è" : "";
            const isBlocked = user.is_blocked;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${user.ID}</td>
                <td>
                    <input type="text" value="${user.username}" data-id="${user.ID}" class="form-control form-control-sm username-input" ${isSuperadmin ? "disabled" : ""} />
                </td>
                <td>${user.email}</td>
                <td>
                    <select class="form-select form-select-sm role-select" data-id="${user.ID}" ${isSuperadmin ? "disabled" : ""}>
                        <option value="user" ${user.role === "user" ? "selected" : ""}>user</option>
                        <option value="admin" ${user.role === "admin" ? "selected" : ""}>admin</option>
                        <option value="superadmin" ${user.role === "superadmin" ? "selected" : ""}>superadmin</option>
                    </select>
                    ${roleBadge}
                </td>
                <td>${isBlocked ? "üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" : "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"}</td>
                <td>
                    ${isBlocked
                ? `<button class="btn btn-sm btn-success" onclick="unblockUser(${user.ID})">–†–∞–∑–±–∞–Ω</button>`
                : `<button class="btn btn-sm btn-danger" onclick="blockUser(${user.ID})" ${isSuperadmin ? "disabled" : ""}>–ë–∞–Ω</button>`
            }
                    <button class="btn btn-sm btn-warning" onclick="updateUsername(${user.ID})" ${isSuperadmin ? "disabled" : ""}>–ò–º—è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll(".role-select").forEach(select => {
            select.addEventListener("change", async e => {
                const id = e.target.dataset.id;
                const newRole = e.target.value;
                const res = await fetch(`/api/users/${id}/role`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + localStorage.getItem("token")
                    },
                    body: JSON.stringify({ role: newRole })
                });
                const result = await res.json();
                alert(result.message || result.error);
                loadUsers();
            });
        });
    }

    async function blockUser(id) {
        if (!confirm("–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
        const res = await fetch(`/api/users/${id}/block`, {
            method: "PUT",
            headers: { Authorization: "Bearer " + localStorage.getItem("token") }
        });
        const result = await res.json();
        alert(result.message || result.error);
        loadUsers();
    }

    async function unblockUser(id) {
        if (!confirm("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
        const res = await fetch(`/api/users/${id}/unblock`, {
            method: "PUT",
            headers: { Authorization: "Bearer " + localStorage.getItem("token") }
        });
        const result = await res.json();
        alert(result.message || result.error);
        loadUsers();
    }

    async function updateUsername(id) {
        const input = document.querySelector(`.username-input[data-id="${id}"]`);
        const username = input.value.trim();
        if (!username) return alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");

        const res = await fetch(`/api/users/${id}/username`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({ username })
        });
        const result = await res.json();
        alert(result.message || result.error);
        loadUsers();
    }

    loadUsers();
</script>
{{ end }}
