{{ define "profile.html" }}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm rounded-4 bg-dark text-light">
            <div class="card-body p-4">

                <div class="text-center mb-4">
                    <img id="avatar" src="" class="rounded-circle shadow mb-2 border border-info" style="width: 100px; height: 100px; object-fit: cover;">
                    <h4 id="displayUsername" class="mb-1"></h4>
                    <small id="displayRole" class="text-muted"></small>
                </div>

                <!-- üñºÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->
                <form id="avatarForm" enctype="multipart/form-data" class="mb-4">
                    <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                    <div class="input-group">
                        <input type="file" class="form-control" name="avatar" accept="image/*" required>
                        <button class="btn btn-outline-info" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </form>

                <form id="profileForm" class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>

                <hr class="border-secondary">

                <h5 class="text-info">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h5>
                <form id="passwordForm" class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" name="old_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" name="new_password" required>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </form>

                <hr class="border-secondary">

                <div class="text-center">
                    <h6 class="text-danger">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h6>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch("/api/profile", { credentials: 'include' });
            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è");

            const user = await res.json();

            document.querySelector("[name=username]").value = user.username;
            document.querySelector("[name=email]").value = user.email;
            document.getElementById("displayUsername").textContent = user.username;
            document.getElementById("displayRole").textContent = "–†–æ–ª—å: " + user.role.toUpperCase();
            document.getElementById("avatar").src = user.image_url || `https://ui-avatars.com/api/?name=${user.username}&background=0D8ABC&color=fff&size=80`;
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è");
        }
    });

    document.getElementById("avatarForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch("/api/profile/avatar", {
                method: "POST",
                body: formData,
                credentials: "include"
            });
            const result = await res.json();
            if (res.ok) {
                alert("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!");
                document.getElementById("avatar").src = result.image_url;
            } else {
                alert(result.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞");
            }
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞");
        }
    });

    document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
            username: form.username.value.trim(),
            email: form.email.value.trim()
        };
        try {
            const res = await fetch("/api/profile", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            alert(res.ok ? "–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!" : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã");
        }
    });

    document.getElementById("passwordForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
            old_password: form.old_password.value,
            new_password: form.new_password.value
        };
        try {
            const res = await fetch("/api/profile/password", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            alert(res.ok ? "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!" : "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è");
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è");
        }
    });

    async function deleteAccount() {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) return;
        try {
            const res = await fetch("/api/profile", {
                method: "DELETE",
                credentials: 'include'
            });
            if (res.ok) {
                alert("–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω");
                window.location.href = "/register";
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞");
            }
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
        }
    }
</script>
{{ end }}
